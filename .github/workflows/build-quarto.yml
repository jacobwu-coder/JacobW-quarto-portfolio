name: Build Quarto Site

on:
push:
branches: [ main ]
pull_request:
branches: [ main ]

jobs:
<<<<<<< HEAD
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install Quarto
        uses: quarto-dev/quarto-actions/setup@v2
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
      - name: Fetch funStuffs plots artifact via API (Python)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'PY'
import os, requests, zipfile, io
G='https://api.github.com'
owner='jacobwu-coder'
repo='funStuffs'
workflow_name='Build and Upload Plots'
artifact_name='funstuff-plots'
headers={'Authorization':f'token {os.environ.get("GITHUB_TOKEN")}', 'Accept':'application/vnd.github.v3+json'}
# find latest successful workflow run by name
runs_url=f'{G}/repos/{owner}/{repo}/actions/runs'
r=requests.get(runs_url, headers=headers, timeout=30)
if r.status_code!=200:
    print('Failed to list runs', r.status_code); raise SystemExit(0)
data=r.json()
run_id=None
for run in data.get('workflow_runs',[]):
    if run.get('name')==workflow_name and run.get('conclusion')=='success':
        run_id=run.get('id'); break
if not run_id:
    print('No successful run found for', workflow_name)
    raise SystemExit(0)
print('Found run', run_id)
artifacts_url=f'{G}/repos/{owner}/{repo}/actions/runs/{run_id}/artifacts'
r=requests.get(artifacts_url, headers=headers, timeout=30)
if r.status_code!=200:
    print('Failed to list artifacts', r.status_code); raise SystemExit(0)
arts=r.json().get('artifacts',[])
artifact_id=None
for a in arts:
    if a.get('name')==artifact_name:
        artifact_id=a.get('id'); break
if not artifact_id:
    print('Artifact not found in run')
    raise SystemExit(0)
print('Found artifact', artifact_id)
download_url=f'{G}/repos/{owner}/{repo}/actions/artifacts/{artifact_id}/zip'
rr=requests.get(download_url, headers=headers, timeout=60, stream=True)
if rr.status_code!=200:
    print('Failed to download artifact', rr.status_code); raise SystemExit(0)
# extract zip into external/funStuff/plots
os.makedirs('external/funStuff/plots', exist_ok=True)
with zipfile.ZipFile(io.BytesIO(rr.content)) as z:
    z.extractall('external/funStuff/plots')
print('Extracted artifact to external/funStuff/plots')
PY
      - name: Render site
        run: quarto render index.qmd --to html --output index.html
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: quarto-site
          path: index.html
=======
build:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v4
- name: Set up Python
    uses: actions/setup-python@v4
    with:
      python-version: '3.x'

  - name: Install Quarto
    uses: quarto-dev/quarto-actions/setup@v2

  - name: Install Python deps
    run: |
      python -m pip install --upgrade pip
      python -m pip install -r requirements.txt

  - name: Fetch funStuffs plots artifact from funStuffs repo
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    run: |
      set -euo pipefail
      repo_owner=jacobwu-coder
      repo_name=funStuffs
      workflow_name="Build and Upload Plots"
      artifact_name="funstuff-plots"

      echo "Finding last successful workflow run in $repo_owner/$repo_name for workflow '$workflow_name'..."
      runs_url="https://api.github.com/repos/${repo_owner}/${repo_name}/actions/runs"
      run_id=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$runs_url" | jq -r ".workflow_runs[] | select(.name==\"$workflow_name\" and .conclusion==\"success\") | .id" | head -n1)
      if [ -z "$run_id" ]; then
        echo "No successful workflow run found for $workflow_name in $repo_owner/$repo_name. Continuing without plots."
        exit 0
      fi
      echo "Found run id $run_id. Listing artifacts..."
      artifacts_url="https://api.github.com/repos/${repo_owner}/${repo_name}/actions/runs/${run_id}/artifacts"
      artifact_id=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$artifacts_url" | jq -r ".artifacts[] | select(.name==\"$artifact_name\") | .id")
      if [ -z "$artifact_id" ]; then
        echo "Artifact $artifact_name not found in run $run_id. Continuing without plots."
        exit 0
      fi
      echo "Found artifact id $artifact_id. Downloading..."
      download_url="https://api.github.com/repos/${repo_owner}/${repo_name}/actions/artifacts/${artifact_id}/zip"
      mkdir -p external/funStuff/plots
      curl -L -H "Authorization: token $GITHUB_TOKEN" -o /tmp/${artifact_name}.zip "$download_url"
      echo "Unzipping artifact..."
      unzip -o /tmp/${artifact_name}.zip -d external/funStuff/plots || true
      echo "Done: artifact extracted to external/funStuff/plots"

  - name: Render site
    run: quarto render index.qmd --to html --output index.html

  - name: Upload artifact
    uses: actions/upload-artifact@v4
    with:
      name: quarto-site
      path: index.html
>>>>>>> origin/main
